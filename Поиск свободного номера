ПРоцедура ПодбратьНовыйНомер()

Запрос = Новый Запрос ;

Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1

| РеализацияТоваровУслуг.Ссылка КАК Ссылка

|ИЗ

| Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг

|ГДЕ

| ГОД(РеализацияТоваровУслуг.Дата) = &ГодДаты

| И РеализацияТоваровУслуг.Номер = &Номер";

Запрос.УстановитьПараметр("ГодДаты",Год(Дата));

Префикс = Лев(Номер,5);

Для н = 10000 по 999999 цикл

Номер = Префикс+ Формат(н,"ЧЦ=6; ЧВН=; ЧГ=0");

Запрос.УстановитьПараметр("Номер",Номер) ;

Выборка = Запрос.Выполнить().Выбрать() ;

Если Не Выборка.Следующий() Тогда

Прервать ;

КонецЕсли ;

КонецЦикла;

Если н = 99999 Тогда

ВызватьИсключение ("Невозможно подобрать новый номер для документа ""Реализация""") ;

КонецЕсли ;

КонецПРоцедуры

&После("ПередЗаписью")

Процедура РасшНомерРеализации_ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)

Если ОбменДанными.Загрузка Тогда

Возврат;

КонецЕсли;

// Номер уже заполнен ,

// Особенность базы 2020 г , получаются номера вида ППОО-9999 + 2 пробела

Если ЭтоНовый() и Прав(Номер,7)="-9999 " Тогда

УстановитьПривилегированныйРежим(Истина) ;

ПодбратьНовыйНомер() ;

УстановитьПривилегированныйРежим(Ложь) ;

КонецЕсли;

КонецПроцедуры
